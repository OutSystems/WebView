<Project>
  <PropertyGroup>

    <BuildDependsOn>
      VG_SetVariables;
      VG_CopyContentFiles;
      VG_LinkNodeModules;
      VG_GenerateDefaultStyleSheet;
      VG_GenerateBundle;
      $(BuildDependsOn);
    </BuildDependsOn>

    <CleanDependsOn>
      VG_UnlinkNodeModules;
      VG_CleanLegacyEntryFiles;
      VG_CleanLegacyJSFiles;
      VG_CleanLegacyCSSFiles;
      $(CleanDependsOn);
    </CleanDependsOn>

    <PrepareResourceNamesDependsOn>
      VG_IncludeGeneratedResources;
      $(PrepareResourceNamesDependsOn)
    </PrepareResourceNamesDependsOn>
  </PropertyGroup>

  <Target Name="VG_SetVariables">
    <ItemGroup>     
      <_ViewGeneratorNodeJsExe Include="$(MSBuildThisFileDirectory)..\..\..\Node.js.redist\*\tools\win-x64\node.exe"/>
      <_ViewGeneratorNodeJsExe Include="$(MSBuildThisFileDirectory)..\..\Node.js.redist*\tools\win-x64\node.exe"/>
    </ItemGroup>
    <PropertyGroup>
      <ViewGeneratorPath>$([System.IO.Path]::GetFullPath(&quot;$(MSBuildThisFileDirectory)..\&quot;))</ViewGeneratorPath>
      <ViewGeneratorToolsPath>$(ViewGeneratorPath)tools</ViewGeneratorToolsPath>
      <ViewGeneratorContentFilesPath>$(ViewGeneratorPath)contentFiles\</ViewGeneratorContentFilesPath>
      <ViewGeneratorNodeJsExe>@(_ViewGeneratorNodeJsExe)</ViewGeneratorNodeJsExe>
    </PropertyGroup>
  </Target>

  <Target Name="VG_LinkNodeModules" Condition="'$(PluginsRelativePath)' != '' AND !Exists('$(ProjectDir)node_modules\webview.plugins')" >
    <Exec Command="mklink /J &quot;$(ProjectDir)node_modules\webview.plugins&quot; &quot;$(ProjectDir)$(PluginsRelativePath)node_modules&quot;" />
  </Target>

  <Target Name="VG_UnlinkNodeModules" Condition="Exists('$(ProjectDir)node_modules\webview.plugins')">
    <RemoveDir Directories="$(ProjectDir)node_modules\webview.plugins" />
  </Target>
    
  <Target Name="VG_CleanLegacyEntryFiles" >
    <ItemGroup>
      <EntryFilesToDelete Include="**\*.entry" />
    </ItemGroup>
    <Message Text="Deleting old files: @(EntryFilesToDelete)" Importance="high" />
    <Delete Files="@(EntryFilesToDelete)"/>
  </Target>

  <Target Name="VG_CleanLegacyJSFiles" >
    <ItemGroup>
      <JSFilesToDelete Include="**\*.js" Exclude="node_modules\**\*.js"/>
    </ItemGroup>
    <Message Text="Deleting old files: @(JSFilesToDelete)" Importance="high" />
    <Delete Files="@(JSFilesToDelete)"/>
  </Target>

  <Target Name="VG_CleanLegacyCSSFiles" >
    <ItemGroup>
      <CSSFilesToDelete Include="**\*.css" Exclude="node_modules\**\*.css;**\*.min.css"/>
    </ItemGroup>
    <Message Text="Deleting old files: @(CSSFilesToDelete)" Importance="high" />
    <Delete Files="@(CSSFilesToDelete)"/>
  </Target>

  <Target Name="VG_SetupViewPacker" DependsOnTargets="VG_EnsureViewPackerInstalled" Condition="!Exists('$(ViewGeneratorToolsPath)\webpack\node_modules')">
    <Exec Command="mklink /J &quot;$(ViewGeneratorToolsPath)\webpack\node_modules&quot; &quot;$(ViewPackerToolNodeModules)&quot;" />
  </Target>
  
  <Target Name="VG_GenerateDefaultStyleSheet" DependsOnTargets="VG_SetupViewPacker;VG_SetVariables;VG_LinkNodeModules" Inputs="@(DefaultStyleSheet)" Outputs="%(DefaultStyleSheet.Filename).css" >
    <PropertyGroup Condition=" '$(Configuration)' == 'Debug' ">
      <WebpackBuildMode>development</WebpackBuildMode>
    </PropertyGroup>

    <PropertyGroup Condition=" '$(Configuration)' == 'Release' ">
      <WebpackBuildMode>production</WebpackBuildMode>
    </PropertyGroup>
    <Exec Command="&quot;$(ViewGeneratorNodeJsExe)&quot; &quot;$(ViewPackerToolScript)&quot; --config &quot;$(ViewGeneratorToolsPath)\webpack\webpack_stylesheets.config.js&quot; --mode $(WebpackBuildMode) --entryPath &quot;%(DefaultStyleSheet.Identity)&quot;" />
  </Target>

  <Target Name="VG_EnsureViewPackerInstalled" Condition="'$(ViewPackerToolScript)' == ''">
    <Error Text="View Packer dependency is not installed" />
  </Target>
  
  <Target Name="VG_GenerateBundle" DependsOnTargets="VG_SetupViewPacker;VG_SetVariables;VG_CopyContentFiles;VG_GenerateDefaultStyleSheet">
    <PropertyGroup Condition="'$(WebpackConfigFileName)' == ''">
      <WebpackConfigFileName>webpack_views</WebpackConfigFileName>
    </PropertyGroup>

    <PropertyGroup Condition=" '$(Configuration)' == 'Debug' ">
      <WebpackBuildMode>development</WebpackBuildMode>
    </PropertyGroup>

    <PropertyGroup Condition=" '$(Configuration)' == 'Release' ">
      <WebpackBuildMode>production</WebpackBuildMode>
    </PropertyGroup>

    <Exec Command="&quot;$(ViewGeneratorNodeJsExe)&quot; &quot;$(ViewPackerToolScript)&quot; --config &quot;$(ViewGeneratorToolsPath)\webpack\$(WebpackConfigFileName).config.js&quot; --mode $(WebpackBuildMode) --pluginsRelativePath &quot;$(PluginsRelativePath)&quot;" />
  </Target>

  <Target Name="VG_IncludeGeneratedResources" DependsOnTargets="VG_GenerateBundle">
    <ItemGroup>
      <EmbeddedResource Include="**\*.js" Exclude="node_modules\**\*.js" />
      <EmbeddedResource Include="**\*.css" Exclude="node_modules\**\*.css;**\*.min.css" />
      <EmbeddedResource Include="**\*.entry" />
    </ItemGroup>
  </Target>
  
  <Target Name="VG_CopyContentFiles" DependsOnTargets="VG_SetVariables" Condition="!Exists('$(ProjectDir)viewgenerator.cache') OR $([System.IO.File]::GetLastWriteTime('$(ViewGeneratorContentFilesPath)viewgenerator.cache').Ticks) &gt; $([System.IO.File]::GetLastWriteTime('$(ProjectDir)viewgenerator.cache').Ticks)">
    <CreateItem Include="$(ViewGeneratorContentFilesPath)viewgenerator.cache">
      <Output TaskParameter="Include" ItemName="CacheFile"/>
    </CreateItem>
    <CreateItem Include="$(ViewGeneratorContentFilesPath)*.json">
      <Output TaskParameter="Include" ItemName="TemplatesToCopy"/>
    </CreateItem>
    <CreateItem Include="$(ViewGeneratorContentFilesPath)**\*.d.ts">
      <Output TaskParameter="Include" ItemName="FilesToCopy"/>
    </CreateItem>
    <Message Text="Copying View Generator content files" Importance="Normal" />
    <Copy SourceFiles="@(CacheFile)" DestinationFolder="$(ProjectDir)%(CacheFile.RecursiveDir)" />
    <Copy SourceFiles="@(TemplatesToCopy)" DestinationFolder="$(ProjectDir)%(TemplatesToCopy.RecursiveDir)" Condition="!Exists('%(FullPath)')" />
    <Copy SourceFiles="@(FilesToCopy)" DestinationFolder="$(ProjectDir)%(FilesToCopy.RecursiveDir)" SkipUnchangedFiles="true" />
  </Target>
  
</Project>